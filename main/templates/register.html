{% extends 'base.html' %}

{% block header %}{% endblock header %}

{% block meta %}
<title>Register - Gung's Padel Shop</title>
{% endblock meta %}

{% block content %}
<div class="container" style="display:grid; place-items:center; min-height:70vh;">
  <div class="card" style="width:min(480px, 100%);">
    <div class="stack">
      <h1 style="margin:0;">Register</h1>
      <form id="registerForm" method="POST" class="stack">
        {% csrf_token %}
        <div class="table-like"><table>{{ form.as_table }}</table></div>
        <button class="btn primary" type="submit" name="submit">Daftar</button>
      </form>
      {% if messages %}
      <ul class="muted" style="margin:0;">
        {% for message in messages %}<li>{{ message }}</li>{% endfor %}
      </ul>
      {% endif %}
      <div class="muted">Sudah punya akun? <a href="{% url 'main:login' %}">Login</a></div>
    </div>
  </div>
</div>

{% endblock content %}

<script>
function getCookie(name) {
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop().split(';').shift();
}

document.getElementById('registerForm').addEventListener('submit', async function(e){
  e.preventDefault();
  const form = e.target;
  const formData = new FormData(form);
  const resp = await fetch("{% url 'main:register' %}", {
    method: 'POST',
    headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': getCookie('csrftoken') },
    body: formData,
  });
  if (resp.headers.get('content-type')?.includes('application/json')) {
    const data = await resp.json();
    if (data.success) {
      showToast('Account created', 'You can now log in', 'success');
      window.location.href = data.redirect_url || "{% url 'main:login' %}";
      return;
    }
  }
  if (resp.ok) {
    showToast('Account created', 'You can now log in', 'success');
    window.location.href = "{% url 'main:login' %}";
  } else {
    showToast('Register failed', 'Please check the form fields', 'error');
  }
});
</script>